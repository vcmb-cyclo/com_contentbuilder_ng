<?php

/**
 * @package     ContentBuilder
 * @author      Markus Bopp / XDA+GIL
 * @link        https://breezingforms.vcmb.fr
 * @copyright   (C) 2026 by XDA+GIL
 * @license     GNU/GPL
 */

namespace CB\Component\Contentbuilder_ng\Administrator;

// no direct access
\defined('_JEXEC') or die('Direct Access to this location is not allowed.');

use Joomla\CMS\Factory;
use Joomla\Database\DatabaseInterface;
use Joomla\CMS\Language\Text;
use CB\Component\Contentbuilder_ng\Administrator\CBRequest;
use CB\Component\Contentbuilder_ng\Administrator\Controller\TestController;

if ((Factory::getApplication()->input->getCmd('controller', '') == 'elementoptions' || 
    Factory::getApplication()->input->getCmd('controller', '') == 'storages' || 
    Factory::getApplication()->input->getCmd('controller', '') == 'forms' || 
    Factory::getApplication()->input->getCmd('controller', '') == 'users') && !Factory::getApplication()->getIdentity()->authorise('contentbuilder_ng.manage', 'com_contentbuilder_ng')) {
    Factory::getApplication()->enqueueMessage(Text::_('JERROR_ALERTNOAUTHOR'), 'warning');
}

if (!(Factory::getApplication()->input->getCmd('controller', '') == 'elementoptions' ||
    Factory::getApplication()->input->getCmd('controller', '') == 'storages' ||
    Factory::getApplication()->input->getCmd('controller', '') == 'forms' ||
    Factory::getApplication()->input->getCmd('controller', '') == 'users') && !Factory::getApplication()->getIdentity()->authorise('contentbuilder_ng.admin', 'com_contentbuilder_ng')) {
    Factory::getApplication()->enqueueMessage(Text::_('JERROR_ALERTNOAUTHOR'), 'warning');
}

require_once(JPATH_SITE . '/administrator/components/com_contentbuilder_ng/src/contentbuilder_ng.php');

$db     = Factory::getContainer()->get(DatabaseInterface::class);
$db->setQuery("Select `id`,`name` From #__contentbuilder_ng_forms Where display_in In (1,2) And published = 1");
$forms = $db->loadAssocList();

/*
foreach($forms As $form){

    ContentbuilderLegacyHelper::createBackendMenuItem($form['id'], $form['name'], true);
}*/

// Require the base controller
require_once(JPATH_COMPONENT_ADMINISTRATOR . '/controller.php');

if (Factory::getApplication()->input->getWord('task') === 'test') {

    // Charger les classes modernes
    require_once JPATH_COMPONENT_ADMINISTRATOR . '/src/Controller/TestController.php';
    require_once JPATH_COMPONENT_ADMINISTRATOR . '/src/View/Test/HtmlView.php';

    // Créer un controller temporaire pour task=test
    $container = \Joomla\CMS\Factory::getContainer();

    $db = $container->get(\Joomla\Database\DatabaseInterface::class);
    $factory = $container->get(\Joomla\CMS\MVC\Factory\MVCFactoryInterface::class);

    $controller = new TestController([], $db, $factory);
    $controller->display();

    // Stoppe le reste du legacy dispatcher
    return;
}

// Require specific controller if requested
$controller = trim(Factory::getApplication()->input->getWord('controller'));

// Vérifier si c'est la task "test" pour le MVC moderne
if (Factory::getApplication()->input->getWord('task') === 'test') {

    // Charger les classes nécessaires si besoin
    require_once JPATH_COMPONENT_ADMINISTRATOR . '/src/Controller/TestController.php';
    require_once JPATH_COMPONENT_ADMINISTRATOR . '/src/View/Test/HtmlView.php';

    // Récupérer les services Joomla
    $factory = Factory::getContainer()->get(\Joomla\CMS\MVC\Factory\MVCFactoryInterface::class);
    $db      = Factory::getContainer()->get(\Joomla\Database\DatabaseInterface::class);

    // Instancier le contrôleur moderne
    $controller = new \CB\Component\Contentbuilder_ng\Administrator\Controller\TestController([], $db, $factory);

    // Exécuter la display() du TestController
    $controller->display();

    // Stopper l’exécution pour éviter que le reste du Legacy Dispatcher s’exécute
    return;
}


if ($controller) {
    $path = JPATH_COMPONENT_ADMINISTRATOR . '/controllers/' . $controller . '.php';
    if (file_exists($path)) {
        require_once $path;
    } else {
        $controller = '';
    }
}

// Create the controller
$classname    = 'ContentbuilderController' . ucfirst($controller);
$controller   = new $classname();

// Perform the Request task
$controller->execute(Factory::getApplication()->input->getWord('task'));

// Redirect if set by the controller
$controller->redirect();
