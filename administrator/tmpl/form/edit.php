<?php

/**
 * @package     ContentBuilder NG
 * @author      Markus Bopp / XDA+GIL
 * @link        https://breezingforms.vcmb.fr
 * @copyright   Copyright (C) 2026 by XDA+GIL 
 * @license     GNU/GPL
 */

// No direct access
\defined('_JEXEC') or die('Restricted access');

use Joomla\CMS\Factory;
use Joomla\CMS\HTML\HTMLHelper;
use Joomla\CMS\Language\Text;
use Joomla\CMS\Router\Route;
use CB\Component\Contentbuilder_ng\Administrator\Helper\ContentbuilderLegacyHelper;
use CB\Component\Contentbuilder_ng\Administrator\Helper\ContentbuilderHelper;
?>
<?php
$wa = Factory::getApplication()->getDocument()->getWebAssetManager();
$wa->addInlineStyle('.saveorder.btn{background-color:#fff;border-color:#ced4da;color:#1b1b1b}.saveorder.btn:hover{background-color:#f8f9fa}.cb-order-slot{display:inline-block;width:24px;text-align:center}.cb-order-placeholder{visibility:hidden}.cb-order-input{margin-left:6px}.cb-order-head{vertical-align:middle;white-space:nowrap}.cb-order-head .saveorder{float:none!important;margin-left:6px}.cb-item-label-cell{display:flex;flex-direction:column;gap:4px}.cb-item-label-display{cursor:pointer;width:100%;display:block}.cb-item-order-type{max-width:125px}');

$listOrder = (string) ($this->listOrder ?? 'ordering');
$listDirn  = strtolower((string) ($this->listDirn ?? 'asc'));
$listDirn  = ($listDirn === 'desc') ? 'desc' : 'asc';
$formId    = (int) ($this->item->id ?? 0);

$sortLink = function (string $label, string $field) use ($listOrder, $listDirn, $formId): string {
    $isActive = ($listOrder === $field);
    $nextDir = ($isActive && $listDirn === 'asc') ? 'desc' : 'asc';
    $indicator = $isActive
        ? ($listDirn === 'asc'
            ? ' <span class="ms-1 icon-sort icon-sort-asc" aria-hidden="true"></span>'
            : ' <span class="ms-1 icon-sort icon-sort-desc" aria-hidden="true"></span>')
        : '';
    $url = Route::_(
        'index.php?option=com_contentbuilder_ng&task=form.display&layout=edit&id=' . $formId
            . '&list[ordering]=' . $field . '&list[direction]=' . $nextDir
    );

    return '<a href="' . $url . '">' . htmlspecialchars($label, ENT_QUOTES, 'UTF-8') . $indicator . '</a>';
};

$permHeaderLabel = static function (string $labelKey, string $tipKey): string {
    $label = Text::_($labelKey);
    $tip = Text::_($tipKey);

    return '<span class="cb-perm-header-tip" tabindex="0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="'
        . htmlspecialchars($tip, ENT_QUOTES, 'UTF-8') . '" title="' . htmlspecialchars($tip, ENT_QUOTES, 'UTF-8') . '">'
        . htmlspecialchars($label, ENT_QUOTES, 'UTF-8') . '</span>';
};

$permissionColumns = [
    ['key' => 'listaccess', 'label' => 'COM_CONTENTBUILDER_NG_PERM_LIST_ACCESS', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_LIST_ACCESS_TIP'],
    ['key' => 'view', 'label' => 'COM_CONTENTBUILDER_NG_PERM_VIEW', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_VIEW_TIP'],
    ['key' => 'new', 'label' => 'COM_CONTENTBUILDER_NG_PERM_NEW', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_NEW_TIP'],
    ['key' => 'edit', 'label' => 'COM_CONTENTBUILDER_NG_PERM_EDIT', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_EDIT_TIP'],
    ['key' => 'delete', 'label' => 'COM_CONTENTBUILDER_NG_PERM_DELETE', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_DELETE_TIP'],
    ['key' => 'state', 'label' => 'COM_CONTENTBUILDER_NG_PERM_STATE', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_STATE_TIP'],
    ['key' => 'publish', 'label' => 'COM_CONTENTBUILDER_NG_PUBLISH', 'tip' => 'COM_CONTENTBUILDER_NG_PUBLISH_TIP'],
    ['key' => 'fullarticle', 'label' => 'COM_CONTENTBUILDER_NG_PERM_FULL_ARTICLE', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_FULL_ARTICLE_TIP'],
    ['key' => 'language', 'label' => 'COM_CONTENTBUILDER_NG_PERM_CHANGE_LANGUAGE', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_CHANGE_LANGUAGE_TIP'],
    ['key' => 'rating', 'label' => 'COM_CONTENTBUILDER_NG_PERM_RATING', 'tip' => 'COM_CONTENTBUILDER_NG_PERM_RATING_TIP'],
];

$defaultCheckedForNewPermissions = ['listaccess' => true, 'view' => true, 'new' => true];

$renderCheckbox = static function (string $name, string $id, bool $checked = false, string $value = '1', array $attributes = []): string {
    $html = '<span class="form-check d-inline-block mb-0">';
    $html .= '<input class="form-check-input" type="checkbox"';

    if ($name !== '') {
        $html .= ' name="' . htmlspecialchars($name, ENT_QUOTES, 'UTF-8') . '"';
    }

    $html .= ' id="' . htmlspecialchars($id, ENT_QUOTES, 'UTF-8') . '"';
    $html .= ' value="' . htmlspecialchars($value, ENT_QUOTES, 'UTF-8') . '"';

    if ($checked) {
        $html .= ' checked="checked"';
    }

    foreach ($attributes as $attr => $attrValue) {
        if ($attrValue === null || $attrValue === false) {
            continue;
        }

        $html .= ' ' . htmlspecialchars((string) $attr, ENT_QUOTES, 'UTF-8');

        if ($attrValue !== true) {
            $html .= '="' . htmlspecialchars((string) $attrValue, ENT_QUOTES, 'UTF-8') . '"';
        }
    }

    $html .= ' />';
    $html .= '</span>';

    return $html;
};
?>

<script type="text/javascript">
    function listItemTask(id, task) {

        var f = document.adminForm;
        f.limitstart.value = <?php echo Factory::getApplication()->input->getInt('limitstart', 0) ?>;
        cb = eval('f.' + id);

        if (cb) {
            for (i = 0; true; i++) {
                cbx = eval('f.cb' + i);
                if (!cbx) break;
                cbx.checked = false;
            } // for
            cb.checked = true;
            f.boxchecked.value = 1;

            switch (task) {
                case 'form.publish':
                    task = 'form.listpublish';
                    break;
                case 'form.unpublish':
                    task = 'form.listunpublish';
                    break;
                case 'form.orderdown':
                    task = 'form.listorderdown';
                    break;
                case 'form.orderup':
                    task = 'form.listorderup';
                    break;
            }

            submitbutton(task);
        }
        return false;
    }

    function submitbutton(task) {
        const form = document.getElementById('adminForm') || document.adminForm;
        if (!form) return;

        if (task == 'form.remove') {
            task = 'form.listremove';
        }


        switch (task) {
            case 'form.cancel':
            case 'form.publish':
            case 'form.unpublish':
            case 'form.listpublish':
            case 'form.listunpublish':
            case 'form.listorderdown':
            case 'form.listorderup':
            case 'form.saveorder':
            case 'form.listremove':
            case 'form.list_include':
            case 'form.no_list_include':
            case 'form.search_include':
            case 'form.no_search_include':
            case 'form.linkable':
            case 'form.not_linkable':
            case 'form.editable':
            case 'form.not_editable':
                Joomla.submitform(task);
                break;
            case 'form.save':
            case 'form.save2new':
            case 'form.apply':
                var error = false;
                var nodes = document.adminForm['cid[]'];

                if (document.getElementById('name').value == '') {
                    error = true;
                    alert("<?php echo addslashes(Text::_('COM_CONTENTBUILDER_NG_ERROR_ENTER_FORMNAME')); ?>");
                } else if (nodes) {
                    if (typeof nodes.value != 'undefined') {
                        if (nodes.checked && document.adminForm['elementLabels[' + nodes.value + ']'].value == '') {
                            error = true;
                            alert("<?php echo addslashes(Text::_('COM_CONTENTBUILDER_NG_ERROR_ENTER_FORMNAME_ALL')); ?>");
                            break;
                        }
                    } else {
                        for (var i = 0; i < nodes.length; i++) {
                            if (nodes[i].checked && document.adminForm['elementLabels[' + nodes[i].value + ']'].value == '') {
                                error = true;
                                alert("<?php echo addslashes(Text::_('COM_CONTENTBUILDER_NG_ERROR_ENTER_FORMNAME_ALL')); ?>");
                                break;
                            }
                        }
                    }
                }

                if (!error) {
                    Joomla.submitform(task);
                }

                break;
        }
    }

    function saveorder(n, task) {
        if (task === 'saveorder') {
            task = 'form.saveorder';
        }
        submitbutton(task);
    }

    if (typeof Joomla != 'undefined') {
        Joomla.submitbutton = submitbutton;
        Joomla.listItemTask = listItemTask;
    }

    function contentbuilder_ng_selectAll(checker, type) {
        var type = type == 'fe' ? 'jform[perms_fe][' : 'jform[perms][';
        for (var i = 0; i < document.adminForm.elements.length; i++) {
            if (typeof document.adminForm.elements[i].name != 'undefined' && document.adminForm.elements[i].name.startsWith(type) && document.adminForm.elements[i].name.endsWith(checker.value + "]")) {
                if (checker.checked) {
                    document.adminForm.elements[i].checked = true;
                } else {
                    document.adminForm.elements[i].checked = false;
                }
            }
        }
    }

    function cbNormalizeColorForPreview(value) {
        if (typeof value !== 'string') {
            return '';
        }

        var hex = value.trim().replace(/^#/, '');

        if (/^[0-9a-fA-F]{3}$/.test(hex)) {
            return (
                hex.charAt(0) + hex.charAt(0) +
                hex.charAt(1) + hex.charAt(1) +
                hex.charAt(2) + hex.charAt(2)
            ).toUpperCase();
        }

        if (/^[0-9a-fA-F]{6}$/.test(hex)) {
            return hex.toUpperCase();
        }

        return '';
    }

    function cbNormalizeColorForNativePicker(value) {
        var hex = cbNormalizeColorForPreview(value);
        return hex ? '#' + hex : '';
    }

    function cbPreviewTextColor(hex) {
        var red = parseInt(hex.substr(0, 2), 16);
        var green = parseInt(hex.substr(2, 2), 16);
        var blue = parseInt(hex.substr(4, 2), 16);
        var luminance = ((red * 299) + (green * 587) + (blue * 114)) / 1000;
        return luminance >= 160 ? '#000000' : '#FFFFFF';
    }

    function cbApplyListStateColorPreview(input) {
        if (!input) {
            return;
        }

        var hex = cbNormalizeColorForPreview(input.value);

        if (!hex) {
            input.style.backgroundColor = '';
            input.style.color = '';
            return;
        }

        input.style.backgroundColor = '#' + hex;
        input.style.color = cbPreviewTextColor(hex);
    }

    function cbSyncNativePickerFromTextInput(textInput) {
        if (!textInput) {
            return;
        }

        var pickerId = textInput.getAttribute('data-cb-color-picker-target');

        if (!pickerId) {
            return;
        }

        var picker = document.getElementById(pickerId);

        if (!picker) {
            return;
        }

        var normalized = cbNormalizeColorForNativePicker(textInput.value);

        if (normalized) {
            picker.value = normalized;
        }
    }

    function cbSyncTextInputFromNativePicker(pickerInput) {
        if (!pickerInput) {
            return;
        }

        var textId = pickerInput.getAttribute('data-cb-color-target');

        if (!textId) {
            return;
        }

        var textInput = document.getElementById(textId);

        if (!textInput) {
            return;
        }

        textInput.value = pickerInput.value.replace(/^#/, '').toUpperCase();
        cbApplyListStateColorPreview(textInput);
    }

    function cbInitListStateColorControls() {
        var inputs = document.querySelectorAll('input[data-cb-color-text="1"]');

        for (var i = 0; i < inputs.length; i++) {
            cbApplyListStateColorPreview(inputs[i]);
            cbSyncNativePickerFromTextInput(inputs[i]);
        }
    }

    var cbColorisConfigured = false;
    var cbColorisInitRetries = 0;

    function cbInitColoris() {
        if (cbColorisConfigured) {
            return;
        }

        if (typeof window.Coloris !== 'function') {
            if (cbColorisInitRetries < 12) {
                cbColorisInitRetries++;
                window.setTimeout(cbInitColoris, 250);
            }
            return;
        }

        window.Coloris({
            el: 'input[data-cb-color-text="1"]',
            alpha: false,
            format: 'hex',
            clearButton: false,
            themeMode: 'light'
        });
        cbColorisConfigured = true;
    }

    document.addEventListener('DOMContentLoaded', cbInitListStateColorControls);
    document.addEventListener('DOMContentLoaded', cbInitColoris);
    window.addEventListener('load', cbInitListStateColorControls);
    window.addEventListener('load', cbInitColoris);
    document.addEventListener('shown.bs.tab', cbInitListStateColorControls);
    document.addEventListener('shown.bs.tab', cbInitColoris);
    document.addEventListener('input', function(event) {
        if (event.target && event.target.matches('input[data-cb-color-text="1"]')) {
            cbApplyListStateColorPreview(event.target);
            cbSyncNativePickerFromTextInput(event.target);
            return;
        }

        if (event.target && event.target.matches('input[data-cb-color-picker="1"]')) {
            cbSyncTextInputFromNativePicker(event.target);
        }
    });
    document.addEventListener('change', function(event) {
        if (event.target && event.target.matches('input[data-cb-color-text="1"]')) {
            cbApplyListStateColorPreview(event.target);
            cbSyncNativePickerFromTextInput(event.target);
            return;
        }

        if (event.target && event.target.matches('input[data-cb-color-picker="1"]')) {
            cbSyncTextInputFromNativePicker(event.target);
        }
    });
    window.setTimeout(cbInitListStateColorControls, 300);
    window.setTimeout(cbInitListStateColorControls, 1200);
    window.setTimeout(cbInitColoris, 300);
    window.setTimeout(cbInitColoris, 1200);
</script>
<form action="index.php" method="post" name="adminForm" id="adminForm">
    <div class="w-100 row" style="margin-left: 20px; overflow-x: auto;">

        <?php
        $advancedOptionsContent = '';
        // DÃ©marrer les onglets
        echo HTMLHelper::_('uitab.startTabSet', 'view-pane', ['active' => 'tab0']);
        // Premier onglet
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab0', Text::_('COM_CONTENTBUILDER_NG_VIEW'));
        ?>

        <table width="100%">
            <tr>
                <td valign="top">

                    <fieldset class="border rounded p-3 mb-3">

                        <label for="name">
                            <span class="editlinktip hasTip"
                                title="<?php echo Text::_('COM_CONTENTBUILDER_NG_VIEW_NAME_TIP'); ?>"><b>
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_NAME'); ?>:
                                </b></span>
                        </label>
                        <input class="form-control form-control-sm" type="text" name="jform[name]" id="name" size="32"
                            style="width: 200px;" maxlength="255"
                            value="<?php echo htmlentities($this->item->name ?? '', ENT_QUOTES, 'UTF-8'); ?>" />

                        <label for="tag">
                            <span class="editlinktip hasTip"
                                title="<?php echo Text::_('COM_CONTENTBUILDER_NG_VIEW_TAG_TIP'); ?>"><b>
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_TAG'); ?>:
                                </b></span>
                        </label>
                        <input class="form-control form-control-sm" type="text" name="jform[tag]" id="tag" size="32"
                            style="width: 200px;" maxlength="255"
                            value="<?php echo htmlentities($this->item->tag ?? '', ENT_QUOTES, 'UTF-8'); ?>" />

                        <?php
                        if ($this->item->id < 1) {
                        ?>
                            <label for="types">
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE_TIP'); ?>"><b>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE'); ?>:
                                    </b></span>
                            </label>
                            <select class="form-select-sm" name="jform[type]">
                                <?php
                                foreach ($this->item->types as $type) {
                                    if (trim($type)) {
                                ?>
                                        <option value="<?php echo $type ?>">
                                            <?php echo $type ?>
                                        </option>
                                <?php
                                    }
                                }
                                ?>
                            </select>

                        <?php
                        } else {
                        ?>
                            <div></div>

                            <div class="alert">
                                <label for="name">
                                    <b>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_FORM_SOURCE'); ?>:
                                    </b>
                                </label>
                                <?php

                                if (!$this->item->reference_id) {
                                ?>
                                    <select class="form-select-sm" name="jform[reference_id]" style="max-width: 200px;">
                                        <?php
                                        foreach ($this->item->forms as $reference_id => $title) {
                                        ?>
                                            <option value="<?php echo $reference_id ?>">
                                                <?php echo htmlentities($title ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                            </option>
                                        <?php
                                        }
                                        ?>
                                    </select>
                                <?php
                                } else {
                                ?>
                                    <?php echo htmlentities($this->item->form->getTitle() ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    <input type="hidden" name="jform[reference_id]"
                                        value="<?php echo $this->item->form->getReferenceId(); ?>" />
                                <?php
                                }
                                ?>

                                <label for="types">
                                    <span class="editlinktip hasTip"
                                        title="<?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE_TIP'); ?>"><b>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE'); ?>:
                                        </b></span>
                                </label>
                                <?php echo $this->item->type ?>
                                <input type="hidden" name="jform[type]" value="<?php echo $this->item->type ?>" />
                                <input type="hidden" name="jform[type_name]"
                                    value="<?php echo isset($this->item->type_name) ? $this->item->type_name : ''; ?>" />
                                <?php
                                if ($this->item->type != 'com_contentbuilder_ng') {
                                ?>
                                    <input type="hidden" name="jform[edit_by_type]" value="0" />
                                    <?php echo $renderCheckbox('jform[edit_by_type]', 'edit_by_type', (bool) $this->item->edit_by_type); ?>
                                    <label class="form-check-label" for="edit_by_type">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE_EDIT'); ?>
                                    </label>
                                <?php
                                } else {
                                ?>
                                    <input type="hidden" name="jform[edit_by_type]" value="0" />
                                <?php
                                }
                                ?>
                                <input type="hidden" name="jform[email_notifications]" value="0" />
                                <?php echo $renderCheckbox('jform[email_notifications]', 'email_notifications', (bool) $this->item->email_notifications); ?>
                                <label class="form-check-label" for="email_notifications">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE_EMAIL_NOTIFICATIONS'); ?>
                                </label>
                                <input type="hidden" name="jform[email_update_notifications]" value="0" />
                                <?php echo $renderCheckbox('jform[email_update_notifications]', 'email_update_notifications', (bool) $this->item->email_update_notifications); ?>
                                <label class="form-check-label" for="email_update_notifications">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_TYPE_EMAIL_UPDATE_NOTIFICATIONS'); ?>
                                </label>

                            </div>

                            <div></div>

                        <?php
                        }
                        ?>

                        <?php ob_start(); ?>
                        <div class="bg-light p-3" id="advancedOptions">

                            <fieldset>
                                <legend>
                                    <h3 class="editlinktip hasTip"
                                        title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DISPLAY_TIP'); ?>">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_DISPLAY'); ?>
                                    </h3>
                                </legend>


                                <select class="form-select-sm" name="jform[display_in]">
                                    <option value="0" <?php echo $this->item->display_in == 0 ? ' selected="selected"' : '' ?>>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_DISPLAY_FRONTEND') ?>
                                    </option>
                                    <option value="1" <?php echo $this->item->display_in == 1 ? ' selected="selected"' : '' ?>>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_DISPLAY_BACKEND') ?>
                                    </option>
                                    <option value="2" <?php echo $this->item->display_in == 2 ? ' selected="selected"' : '' ?>>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_DISPLAY_BOTH') ?>
                                    </option>
                                </select>

                                <label for="theme_plugin">
                                    <span class="editlinktip hasTip"
                                        title="<?php echo Text::_('COM_CONTENTBUILDER_NG_THEME_PLUGIN_TIP'); ?>"><b>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_THEME_PLUGIN'); ?>:
                                        </b></span>
                                </label>
                                <select class="form-select-sm" name="jform[theme_plugin]" id="theme_plugin">
                                    <?php
                                    foreach ($this->theme_plugins as $theme_plugin) {
                                    ?>
                                        <option value="<?php echo $theme_plugin; ?>" <?php echo $theme_plugin == $this->item->theme_plugin ? ' selected="selected"' : ''; ?>>
                                            <?php echo $theme_plugin; ?>
                                        </option>
                                    <?php
                                    }
                                    ?>
                                </select>

                            </fieldset>

                            <hr />

                            <fieldset>
                                <legend>
                                    <h3 class="editlinktip hasTip"
                                        title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_COLUMNS_TIP'); ?>">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW'); ?>
                                    </h3>
                                </legend>


                                <div class="row gx-3 gy-1 mt-0">
                                    <div class="col-12 col-xl-7">
                                        <div class="border rounded bg-white p-3 h-100">
                                            <h4 class="h6 text-secondary mb-2">
                                                <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_DATA_OPTIONS'); ?>
                                            </h4>
                                            <div class="d-flex flex-wrap align-items-center gap-3">
                                            <div>
                                                <input type="hidden" name="jform[show_id_column]" value="0" />
                                                <?php echo $renderCheckbox('jform[show_id_column]', 'show_id_column', (bool) $this->item->show_id_column); ?>
                                                <label class="form-check-label" for="show_id_column">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_ID_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_ID_COLUMN'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[select_column]" value="0" />
                                                <?php echo $renderCheckbox('jform[select_column]', 'select_column', (bool) $this->item->select_column); ?>
                                                <label class="form-check-label" for="select_column">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_SELECT_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SELECT_COLUMN'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[list_state]" value="0" />
                                                <?php echo $renderCheckbox('jform[list_state]', 'list_state', (bool) $this->item->list_state); ?>
                                                <label class="form-check-label" for="list_state">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_STATE_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_EDIT_STATE'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[list_publish]" value="0" />
                                                <?php echo $renderCheckbox('jform[list_publish]', 'list_publish', (bool) $this->item->list_publish); ?>
                                                <label class="form-check-label" for="list_publish">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_PUBLISH_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PUBLISH'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[list_language]" value="0" />
                                                <?php echo $renderCheckbox('jform[list_language]', 'list_language', (bool) $this->item->list_language); ?>
                                                <label class="form-check-label" for="list_language">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_LANGUAGE_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_LANGUAGE'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[list_article]" value="0" />
                                                <?php echo $renderCheckbox('jform[list_article]', 'list_article', (bool) $this->item->list_article); ?>
                                                <label class="form-check-label" for="list_article">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_ARTICLE_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_ARTICLE'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[list_author]" value="0" />
                                                <?php echo $renderCheckbox('jform[list_author]', 'list_author', (bool) $this->item->list_author); ?>
                                                <label class="form-check-label" for="list_author">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_AUTHOR_COLUMN_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_AUTHOR'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[metadata]" value="0" />
                                                <?php echo $renderCheckbox('jform[metadata]', 'metadata', (bool) $this->item->metadata); ?>
                                                <label class="form-check-label" for="metadata">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_METADATA_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_METADATA'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[show_filter]" value="0" />
                                                <?php echo $renderCheckbox('jform[show_filter]', 'show_filter', (bool) $this->item->show_filter); ?>
                                                <label class="form-check-label" for="show_filter">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_FILTER_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_FILTER'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[show_records_per_page]" value="0" />
                                                <?php echo $renderCheckbox('jform[show_records_per_page]', 'show_records_per_page', (bool) $this->item->show_records_per_page); ?>
                                                <label class="form-check-label" for="show_records_per_page">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_RECORDS_PER_PAGE_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_RECORDS_PER_PAGE'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12 col-xl-5">
                                        <div class="border rounded bg-white p-3 h-100">
                                            <h4 class="h6 text-secondary mb-2">
                                                <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_BUTTON_OPTIONS'); ?>
                                            </h4>
                                            <div class="d-flex flex-wrap align-items-center gap-3">
                                            <div>
                                                <input type="hidden" name="jform[edit_button]" value="0" />
                                                <?php echo $renderCheckbox('jform[edit_button]', 'edit_button', (bool) $this->item->edit_button); ?>
                                                <label class="form-check-label" for="edit_button">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_EDIT_BUTTON_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_EDIT_BUTTON'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[new_button]" value="0" />
                                                <?php echo $renderCheckbox('jform[new_button]', 'new_button', (bool) ($this->item->new_button ?? 0)); ?>
                                                <label class="form-check-label" for="new_button">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_NEW_BUTTON_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_NEW'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[export_xls]" value="0" />
                                                <?php echo $renderCheckbox('jform[export_xls]', 'export_xls', (bool) $this->item->export_xls); ?>
                                                <label class="form-check-label" for="export_xls">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_XLSEXPORT_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_XLSEXPORT'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            <div>
                                                <input type="hidden" name="jform[print_button]" value="0" />
                                                <?php echo $renderCheckbox('jform[print_button]', 'print_button', (bool) $this->item->print_button); ?>
                                                <label class="form-check-label" for="print_button">
                                                    <span class="editlinktip hasTip" title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_PRINTBUTTON_TIP'); ?>">
                                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SHOW_PRINTBUTTON'); ?>
                                                    </span>
                                                </label>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </fieldset>

                            <hr />

                            <fieldset>
                                <legend>
                                    <h3>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_RATING'); ?>
                                    </h3>
                                </legend>
                                <div class="alert">
                                    <input type="hidden" name="jform[list_rating]" value="0" />
                                    <?php echo $renderCheckbox('jform[list_rating]', 'list_rating', (bool) $this->item->list_rating); ?>
                                    <label class="form-check-label" for="list_rating">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_RATING'); ?>
                                    </label>

                                    <select class="form-select-sm" name="jform[rating_slots]" id="rating_slots">
                                        <option value="1" <?php echo $this->item->rating_slots == 1 ? ' selected="selected"' : ''; ?>>1</option>
                                        <option value="2" <?php echo $this->item->rating_slots == 2 ? ' selected="selected"' : ''; ?>>2</option>
                                        <option value="3" <?php echo $this->item->rating_slots == 3 ? ' selected="selected"' : ''; ?>>3</option>
                                        <option value="4" <?php echo $this->item->rating_slots == 4 ? ' selected="selected"' : ''; ?>>4</option>
                                        <option value="5" <?php echo $this->item->rating_slots == 5 ? ' selected="selected"' : ''; ?>>5</option>
                                    </select>
                                    <label for="rating_slots">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_RATING_SLOTS'); ?>
                                    </label>
                                </div>
                            </fieldset>

                            <hr />

                            <fieldset>
                                <legend>
                                    <h3>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_SORTING'); ?>
                                    </h3>
                                </legend>
                                <div class="alert">
                                    <label for="initial_sort_order">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_INITIAL_SORT_ORDER_TIP'); ?>"><b>
                                                <?php echo Text::_('COM_CONTENTBUILDER_NG_INITIAL_SORT_ORDER'); ?>:
                                            </b></span>
                                    </label>
                                    <select class="form-select-sm"
                                        onchange="if(this.selectedIndex == 3) { document.getElementById('randUpdate').style.display='block'; } else { document.getElementById('randUpdate').style.display='none'; } "
                                        name="jform[initial_sort_order]" id="initial_sort_order" style="max-width: 200px;">
                                        <option value="-1">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_INITIAL_SORT_ORDER_BY_ID'); ?>
                                        </option>
                                        <option value="Rating" <?php echo $this->item->initial_sort_order == 'Rating' ? ' selected="selected"' : ''; ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_RATING'); ?>
                                        </option>
                                        <option value="RatingCount" <?php echo $this->item->initial_sort_order == 'RatingCount' ? ' selected="selected"' : ''; ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_RATING_COUNT'); ?>
                                        </option>
                                        <option value="Rand" <?php echo $this->item->initial_sort_order == 'Rand' ? ' selected="selected"' : ''; ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_INITIAL_SORT_ORDER_RAND'); ?>
                                        </option>
                                        <?php
                                        foreach ($this->elements as $sortable) {
                                        ?>
                                            <option value="<?php echo $sortable->reference_id; ?>" <?php echo $this->item->initial_sort_order == $sortable->reference_id ? ' selected="selected"' : ''; ?>>
                                                <?php echo htmlentities($sortable->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                                </value>
                                            <?php
                                        }
                                            ?>
                                    </select>
                                    <span id="randUpdate"
                                        style="display: <?php echo $this->item->initial_sort_order == 'Rand' ? 'block' : 'none' ?>;">
                                        <b>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_RAND_UPDATE'); ?>:
                                        </b>
                                        <input class="form-control form-control-sm" type="text" name="jform[rand_update]"
                                            value="<?php echo $this->item->rand_update; ?>" />
                                    </span>
                                    <select class="form-select-sm" name="jform[initial_sort_order2]" id="initial_sort_order2"
                                        style="max-width: 200px;">
                                        <option value="-1">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_NONE'); ?>
                                        </option>
                                        <?php
                                        foreach ($this->elements as $sortable) {
                                        ?>
                                            <option value="<?php echo $sortable->reference_id; ?>" <?php echo $this->item->initial_sort_order2 == $sortable->reference_id ? ' selected="selected"' : ''; ?>>
                                                <?php echo htmlentities($sortable->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                                </value>
                                            <?php
                                        }
                                            ?>
                                    </select>
                                    <select class="form-select-sm" name="jform[initial_sort_order3]" id="initial_sort_order3"
                                        style="max-width: 200px;">
                                        <option value="-1">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_NONE'); ?>
                                        </option>
                                        <?php
                                        foreach ($this->elements as $sortable) {
                                        ?>
                                            <option value="<?php echo $sortable->reference_id; ?>" <?php echo $this->item->initial_sort_order3 == $sortable->reference_id ? ' selected="selected"' : ''; ?>>
                                                <?php echo htmlentities($sortable->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                                </value>
                                            <?php
                                        }
                                            ?>
                                    </select>
                                    <div></div>
                                    <input class="form-check-input" type="radio" name="jform[initial_order_dir]"
                                        id="initial_order_dir" value="asc" <?php echo $this->item->initial_order_dir == 'asc' ? ' checked="checked"' : ''; ?> /> <label
                                        for="initial_order_dir">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_INITIAL_SORT_ORDER_ASC'); ?>
                                    </label>
                                    <input class="form-check-input" type="radio" name="jform[initial_order_dir]"
                                        id="initial_order_dir_desc" value="desc" <?php echo $this->item->initial_order_dir == 'desc' ? ' checked="checked"' : ''; ?> /> <label
                                        for="initial_order_dir_desc">
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_INITIAL_SORT_ORDER_DESC'); ?>
                                    </label>
                                </div>
                            </fieldset>

                            <hr />

                            <fieldset>
                                <legend>
                                    <h3>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_BUTTONS'); ?>
                                    </h3>
                                </legend>
                                <div class="alert">
                                    <label for="save_button_title">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SAVE_BUTTON_TITLE_TIP'); ?>"><b>
                                                <?php echo Text::_('COM_CONTENTBUILDER_NG_SAVE_BUTTON_TITLE'); ?>:
                                            </b></span>
                                    </label>
                                    <input class="form-control form-control-sm" type="text" id="save_button_title"
                                        name="jform[save_button_title]"
                                        value="<?php echo htmlentities($this->item->save_button_title ?? '', ENT_QUOTES, 'UTF-8'); ?>" />

                                    <label for="apply_button_title">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_APPLY_BUTTON_TITLE_TIP'); ?>"><b>
                                                <?php echo Text::_('COM_CONTENTBUILDER_NG_APPLY_BUTTON_TITLE'); ?>:
                                            </b></span>
                                    </label>
                                    <input class="form-control form-control-sm" type="text" id="apply_button_title"
                                        name="jform[apply_button_title]"
                                        value="<?php echo htmlentities($this->item->apply_button_title ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                                </div>
                            </fieldset>

                            <hr />

                            <fieldset>
                                <legend>
                                    <h3>
                                        <?php echo Text::_('COM_CONTENTBUILDER_NG_MISC'); ?>
                                    </h3>
                                </legend>
                                <div class="alert">
                                    <input type="hidden" name="jform[filter_exact_match]" value="0" />
                                    <?php echo $renderCheckbox('jform[filter_exact_match]', 'filter_exact_match', (bool) $this->item->filter_exact_match); ?>
                                    <label class="form-check-label" for="filter_exact_match">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_FILTER_EXACT_MATCH_TIP'); ?>">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_FILTER_EXACT_MATCH'); ?>
                                        </span>
                                    </label>

                                    <input type="hidden" name="jform[use_view_name_as_title]" value="0" />
                                    <?php echo $renderCheckbox('jform[use_view_name_as_title]', 'use_view_name_as_title', (bool) $this->item->use_view_name_as_title); ?>
                                    <label class="form-check-label" for="use_view_name_as_title">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_USE_VIEW_NAME_AS_TITLE_TIP'); ?>">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_USE_VIEW_NAME_AS_TITLE'); ?>
                                        </span>
                                    </label>

                                    <input type="hidden" name="jform[published_only]" value="0" />
                                    <?php echo $renderCheckbox('jform[published_only]', 'published_only', (bool) $this->item->published_only); ?>
                                    <label class="form-check-label" for="published_only">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_PUBLISHED_ONLY_TIP'); ?>">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PUBLISHED_ONLY'); ?>
                                        </span>
                                    </label>

                                    <input type="hidden" name="jform[allow_external_filter]" value="0" />
                                    <?php echo $renderCheckbox('jform[allow_external_filter]', 'allow_external_filter', (bool) $this->item->allow_external_filter); ?>
                                    <label class="form-check-label" for="allow_external_filter">
                                        <span class="editlinktip hasTip"
                                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_ALLOW_EXTERNAL_FILTER_TIP'); ?>">
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ALLOW_EXTERNAL_FILTER'); ?>
                                        </span>
                                    </label>
                                </div>
                            </fieldset>

                        </div>
                        <?php $advancedOptionsContent = ob_get_clean(); ?>

                    </fieldset>

                </td>
            </tr>
        </table>
        </fieldset>
        </td>
        </tr>
        <tr>
            <td valign="top">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th width="5">
                                <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_ID'), 'id'); ?>
                            </th>
                            <th width="20">
                                <?php echo HTMLHelper::_('grid.checkall'); ?>
                            </th>
                            <th>
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_LABEL_TIP'); ?>">
                                    <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_LABEL'), 'label'); ?>
                                </span>
                            </th>
                            <th>
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_INCLUDE_TIP'); ?>">
                                    <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_LIST_INCLUDE'), 'list_include'); ?>
                                </span>
                            </th>
                            <th>
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_SEARCH_INCLUDE_TIP'); ?>">
                                    <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_SEARCH_INCLUDE'), 'search_include'); ?>
                                </span>
                            </th>
                            <th>
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_LINKABLE_TIP'); ?>">
                                    <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_LINKABLE'), 'linkable'); ?>
                                </span>
                            </th>
                            <th>
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_EDITABLE_TIP'); ?>">
                                    <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_EDITABLE'), 'editable'); ?>
                                </span>
                            </th>
                            <th>
                                <span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_WORDWRAP_TIP'); ?>">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_WORDWRAP'); ?>
                                </span>
                            </th>
                            <th width="150">
                                <span class="editlinktip hasTip"
                                    title="<?php echo ContentbuilderLegacyHelper::allhtmlentities(Text::_('COM_CONTENTBUILDER_NG_LIST_ITEM_WRAPPER_TIP')); ?>">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_ITEM_WRAPPER'); ?>
                                </span>
                            </th>
                            <th>
                                <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_PUBLISHED'), 'published'); ?>
                            </th>
                            <th width="120" class="cb-order-head">
                                <?php if (!empty($this->elements) && is_array($this->elements)) : ?>
                                    <?php echo $sortLink(Text::_('COM_CONTENTBUILDER_NG_ORDERBY'), 'ordering'); ?>
                                    <?php //TODO: dragndrop if ($this->ordering) echo HTMLHelper::_('grid.order',  $this->elements );   
                                    ?>
                                    <?php echo HTMLHelper::_('grid.order', $this->elements); ?>
                                <?php endif; ?>
                            </th>

                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        $k = 0;
                        $n = count($this->elements);
                        for ($i = 0; $i < $n; $i++) {
                            $row = $this->elements[$i];
                            $checked = HTMLHelper::_('grid.id', $i, $row->id);
                            $published = ContentbuilderHelper::listPublish('form', $row, $i);
                            $list_include = ContentbuilderHelper::listIncludeInList('form', $row, $i);
                            $search_include = ContentbuilderHelper::listIncludeInSearch('form', $row, $i);
                            $linkable = ContentbuilderHelper::listLinkable('form', $row, $i);
                            $editable = ContentbuilderHelper::listEditable('form', $row, $i);
                        ?>
                            <tr class="<?php echo "row$k"; ?>">
                                <td valign="top">
                                    <?php echo $row->id; ?>
                                </td>
                                <td valign="top">
                                    <?php echo $checked; ?>
                                </td>
                                <td width="150" valign="top">
                                    <div class="cb-item-label-cell">
                                    <div class="cb-item-label-display"
                                        id="itemLabels_<?php echo $row->id ?>"
                                        onclick="document.getElementById('itemLabels<?php echo $row->id ?>').style.display='block';this.style.display='none';document.getElementById('itemLabels<?php echo $row->id ?>').focus();">
                                        <b>
                                            <?php echo htmlentities($row->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                        </b>
                                    </div>
                                    <input class="form-control form-control-sm"
                                        onblur="if(this.value=='') {this.value = 'Unnamed';} this.style.display='none';document.getElementById('itemLabels_<?php echo $row->id ?>').innerHTML='<b>'+this.value+'<b/>';document.getElementById('itemLabels_<?php echo $row->id ?>').style.display='block';"
                                        id="itemLabels<?php echo $row->id ?>" type="text" style="display:none; width: 100%;"
                                        name="jform[itemLabels][<?php echo $row->id ?>]"
                                        value="<?php echo htmlentities($row->label ?? '', ENT_QUOTES, 'UTF-8') ?>" />

                                    <select class="form-select form-select-sm cb-item-order-type"
                                        id="itemOrderTypes<?php echo $row->id ?>" name="jform[itemOrderTypes][<?php echo $row->id ?>]">
                                        <option value=""> -
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES'); ?> -
                                        </option>
                                        <option value="CHAR" <?php echo $row->order_type == 'CHAR' ? ' selected="selected"' : '' ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES_TEXT'); ?>
                                        </option>
                                        <option value="DATETIME" <?php echo $row->order_type == 'DATETIME' ? ' selected="selected"' : '' ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES_DATETIME'); ?>
                                        </option>
                                        <option value="DATE" <?php echo $row->order_type == 'DATE' ? ' selected="selected"' : '' ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES_DATE'); ?>
                                        </option>
                                        <option value="TIME" <?php echo $row->order_type == 'TIME' ? ' selected="selected"' : '' ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES_TIME'); ?>
                                        </option>
                                        <option value="UNSIGNED" <?php echo $row->order_type == 'UNSIGNED' ? ' selected="selected"' : '' ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES_INTEGER'); ?>
                                        </option>
                                        <option value="DECIMAL" <?php echo $row->order_type == 'DECIMAL' ? ' selected="selected"' : '' ?>>
                                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ORDER_TYPES_DECIMAL'); ?>
                                        </option>
                                    </select>
                                    </div>

                                </td>
                                <td valign="top">
                                    <?php echo $list_include; ?>
                                </td>
                                <td valign="top">
                                    <?php echo $search_include; ?>
                                </td>
                                <td valign="top">
                                    <?php echo $linkable; ?>
                                </td>
                                <td valign="top">
                                    <?php echo $editable; ?>
                                    <?php
                                    if ($row->editable && !$this->item->edit_by_type) {
                                        echo '<div class="mt-1">[<a href="index.php?option=com_contentbuilder_ng&amp;view=elementoptions&amp;tmpl=component&amp;element_id=' . $row->id . '&amp;id=' . $this->item->id . '" title="" data-bs-toggle="modal" data-bs-target="#text-type-modal">' . $row->type . '</a>]</div>';
                                    }
                                    ?>
                                </td>
                                <td valign="top">
                                    <input class="form-control form-control-sm w-100" type="text" style="width: 20px;"
                                        name="jform[itemWordwrap][<?php echo $row->id ?>]"
                                        value="<?php echo htmlentities($row->wordwrap ?? '', ENT_QUOTES, 'UTF-8') ?>" />
                                </td>
                                <td valign="top">
                                    <input class="form-control form-control-sm w-100" style="width: 150px;" type="text"
                                        name="jform[itemWrapper][<?php echo $row->id ?>]"
                                        value="<?php echo htmlentities($row->item_wrapper ?? '', ENT_QUOTES, 'UTF-8') ?>" />
                                </td>
                                <td valign="top">
                                    <?php echo $published; ?>
                                </td>
                                <td class="order" width="150" valign="top">
                                    <?php
                                    $orderUp = '';
                                    $orderDown = '';
                                    if ($this->pagination) {
                                        $orderUp = (string) $this->pagination->orderUpIcon($i, true, 'form.orderup', 'Move Up', $this->ordering);
                                        $orderDown = (string) $this->pagination->orderDownIcon($i, $n, true, 'form.orderdown', 'Move Down', $this->ordering);
                                    }
                                    ?>
                                    <span class="cb-order-slot">
                                        <?php echo $orderUp !== '' ? $orderUp : '<span class="cb-order-placeholder">â¢</span>'; ?>
                                    </span>
                                    <span class="cb-order-slot">
                                        <?php echo $orderDown !== '' ? $orderDown : '<span class="cb-order-placeholder">â¢</span>'; ?>
                                    </span>
                                    <?php $disabled = $this->ordering ? '' : 'disabled="disabled"'; ?>
                                    <input
                                        type="text"
                                        name="jform[order][<?php echo (int) $row->id; ?>]"
                                        size="3"
                                        style="width:30px;text-align:center;margin-left:20px"
                                        value="<?php echo (int) $row->ordering; ?>"
                                        <?php echo $disabled; ?>
                                        class="text_area" />
                                </td>
                            </tr>
                        <?php
                            $k = 1 - $k;
                        }
                        ?>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="11">
                                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">

                                    <div class="d-flex flex-wrap align-items-center gap-2">
                                        <?php echo $this->pagination ? $this->pagination->getPagesCounter() : ''; ?>
                                        <span><?php echo Text::_('COM_CONTENTBUILDER_NG_DISPLAY_NUM'); ?>&nbsp;</span>
                                        <span class="d-inline-block">
                                            <?php echo $this->pagination ? $this->pagination->getLimitBox() : ''; ?>
                                        </span>
                                    </div>

                                    <div>
                                        <?php echo $this->pagination ? $this->pagination->getPagesLinks() : ''; ?>
                                    </div>

                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>

            </td>
        </tr>

        </table>

        <?php
        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab9', Text::_('COM_CONTENTBUILDER_NG_ADVANCED_OPTIONS'));
        echo $advancedOptionsContent;
        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab2', Text::_('COM_CONTENTBUILDER_NG_LIST_INTRO_TEXT'));
        echo $this->form->renderField('intro_text');
        ?>

        <?php
        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab1', Text::_('COM_CONTENTBUILDER_NG_LIST_STATES'));
        ?>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_STATES_PUBLISHED') ?>
                    </th>
                    <th>
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_STATES_TITLE') ?>
                    </th>
                    <th>
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_STATES_COLOR') ?>
                    </th>
                    <th>
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_STATES_ACTION') ?>
                    </th>
                </tr>
            </thead>
            <?php
            foreach ($this->item->list_states as $state) {
                $k = 0;
                $stateRawColor = (string) ($state['color'] ?? '');
                $previewHex = strtoupper(ltrim(trim($stateRawColor), '#'));
                if (preg_match('/^[0-9A-F]{3}$/', $previewHex)) {
                    $previewHex = $previewHex[0] . $previewHex[0]
                        . $previewHex[1] . $previewHex[1]
                        . $previewHex[2] . $previewHex[2];
                }
                $stateColorStyle = '';
                if (preg_match('/^[0-9A-F]{6}$/', $previewHex)) {
                    $red = hexdec(substr($previewHex, 0, 2));
                    $green = hexdec(substr($previewHex, 2, 2));
                    $blue = hexdec(substr($previewHex, 4, 2));
                    $textColor = ((($red * 299) + ($green * 587) + ($blue * 114)) / 1000) >= 160 ? '#000000' : '#FFFFFF';
                    $stateColorStyle = 'background-color:#' . $previewHex . ';color:' . $textColor . ';';
                }
                $stateColorInputId = 'list_state_color_' . (int) $state['id'];
                $stateColorPickerId = 'list_state_color_picker_' . (int) $state['id'];
                $stateNativePickerValue = preg_match('/^[0-9A-F]{6}$/', $previewHex) ? '#' . $previewHex : '#FFFFFF';
            ?>
                <tr class="<?php echo "row$k"; ?>">
                    <td>
                        <?php echo $renderCheckbox('jform[list_states][' . $state['id'] . '][published]', 'list_state_published_' . $state['id'], (bool) $state['published']); ?>
                    </td>
                    <td>
                        <input class="form-control form-control-sm w-100" type="text"
                            name="jform[list_states][<?php echo $state['id']; ?>][title]"
                            value="<?php echo htmlentities($state['title'] ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <input
                                class="form-control form-control-sm w-100"
                                type="text"
                                id="<?php echo $stateColorInputId; ?>"
                                data-cb-color-text="1"
                                data-cb-color-picker-target="<?php echo $stateColorPickerId; ?>"
                                value="<?php echo htmlentities($stateRawColor, ENT_QUOTES, 'UTF-8'); ?>"
                                style="<?php echo $stateColorStyle; ?>"
                                name="jform[list_states][<?php echo $state['id']; ?>][color]" />
                            <input
                                class="form-control form-control-color form-control-sm"
                                type="color"
                                id="<?php echo $stateColorPickerId; ?>"
                                data-cb-color-picker="1"
                                data-cb-color-target="<?php echo $stateColorInputId; ?>"
                                value="<?php echo $stateNativePickerValue; ?>"
                                title="<?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_STATES_COLOR'); ?>"
                                aria-label="<?php echo Text::_('COM_CONTENTBUILDER_NG_LIST_STATES_COLOR'); ?>"
                                style="width: 3rem; min-width: 3rem; padding: 0.2rem;" />
                        </div>
                    </td>
                    <td>
                        <select class="form-select-sm" name="jform[list_states][<?php echo $state['id']; ?>][action]">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_NONE'); ?> -
                            </option>
                            <?php
                            foreach ($this->list_states_action_plugins as $list_state_action_plugin) {
                            ?>
                                <option value="<?php echo $list_state_action_plugin; ?>" <?php echo $list_state_action_plugin == $state['action'] ? ' selected="selected"' : ''; ?>>
                                    <?php echo $list_state_action_plugin; ?>
                                </option>
                            <?php
                            }
                            ?>
                        </select>
                    </td>
                </tr>
            <?php
                $k = 1 - $k;
            }
            ?>
        </table>
        <?php
        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab3', Text::_('COM_CONTENTBUILDER_NG_DETAILS_TEMPLATE'));

        ?>
        <table width="100%" class="table table-striped">
            <tr>
                <td width="20%">
                    <label for="create_sample"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE'); ?><span></label>
                </td>
                <td>
                    <input type="hidden" name="jform[create_sample]" value="0" />
                    <?php echo $renderCheckbox('jform[create_sample]', 'create_sample', false); ?>
                    <label class="form-check-label" for="create_sample">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE_SAMPLE'); ?>
                    </label>
                    <input type="hidden" name="jform[create_articles]" value="0" />
                    <?php echo $renderCheckbox('jform[create_articles]', 'create_articles', (int) $this->item->create_articles === 1); ?><label class="form-check-label"
                        for="create_articles">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE_ARTICLES'); ?>
                    </label>
                </td>
                <td width="20%">
                    <label for="delete_articles"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DELETE_ARTICLES_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DELETE_ARTICLES'); ?>
                        </span></label>
                </td>
                <td>
                    <input class="form-check-input" type="radio" value="1" name="jform[delete_articles]" id="delete_articles"
                        <?php echo $this->item->delete_articles ? ' checked="checked"' : '' ?> /> <label
                        for="delete_articles">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_YES'); ?>
                    </label>
                    <input class="form-check-input" type="radio" value="0" name="jform[delete_articles]"
                        id="delete_articles_no" <?php echo !$this->item->delete_articles ? ' checked="checked"' : '' ?> /> <label for="delete_articles_no">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_NO'); ?>
                    </label>
                </td>
            </tr>
            <tr>
                <td width="20%">
                    <label for="title_field"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_TITLE_FIELD_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_TITLE_FIELD'); ?>
                        </span></label>
                </td>
                <td>
                    <select class="form-select-sm" name="jform[title_field]" id="title_field">
                        <?php
                        foreach ($this->all_elements as $sortable) {
                        ?>
                            <option value="<?php echo $sortable->reference_id; ?>" <?php echo $this->item->title_field == $sortable->reference_id ? ' selected="selected"' : ''; ?>>
                                <?php echo htmlentities($sortable->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                </value>
                            <?php
                        }
                            ?>
                    </select>
                </td>
                <td width="20%">
                    <label for="default_category"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_CATEGORY_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_CATEGORY'); ?>
                        </span></label>
                </td>
                <td>
                    <?php
                    ?>
                    <select class="form-select-sm" id="default_category" name="jform[sectioncategories]">
                        <?php
                        foreach ($this->item->sectioncategories as $category) {
                        ?>
                            <option <?php echo $this->item->default_category == $category->value ? ' selected="selected"' : '' ?>value="<?php echo $category->value; ?>">
                                <?php echo htmlentities($category->text ?? '', ENT_QUOTES, 'UTF-8'); ?>
                            </option>
                        <?php
                        }
                        ?>
                    </select>
                    <?php
                    ?>
                </td>
            </tr>
            <tr>
                <td width="20%" valign="top">
                    <label for="default_lang_code"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_LANG_CODE_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_LANG_CODE'); ?>
                        </span></label>
                </td>
                <td valign="top">
                    <select class="form-select-sm" name="jform[default_lang_code]" id="default_lang_code">
                        <option value="*">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ANY'); ?>
                        </option>
                        <?php
                        foreach ($this->item->language_codes as $lang_code) {
                        ?>
                            <option value="<?php echo $lang_code ?>" <?php echo $lang_code == $this->item->default_lang_code ? ' selected="selected"' : ''; ?>>
                                <?php echo $lang_code; ?>
                            </option>
                        <?php
                        }
                        ?>
                    </select>
                    <br /><br />
                    <label for="article_record_impact_language"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_ARTICLE_RECORD_IMPACT_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ARTICLE_RECORD_IMPACT'); ?>
                        </span></label>
                    <input class="form-check-input" <?php echo $this->item->article_record_impact_language ? 'checked="checked" ' : '' ?>type="radio" name="jform[article_record_impact_language]"
                        id="article_record_impact_language" value="1" />
                    <label for="article_record_impact_language_yes">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_YES'); ?>
                    </label>
                    <input class="form-check-input" <?php echo !$this->item->article_record_impact_language ? 'checked="checked" ' : '' ?>type="radio" name="jform[article_record_impact_language]"
                        id="article_record_impact_language_no" value="0" />
                    <label for="article_record_impact_language_no">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_NO'); ?>
                    </label>
                </td>
                <td width="20%" valign="top">
                    <label for="default_lang_code_ignore_yes"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_LANG_CODE_IGNORE_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_LANG_CODE_IGNORE'); ?>
                        </span></label>
                </td>
                <td valign="top">
                    <input class="form-check-input" <?php echo $this->item->default_lang_code_ignore ? 'checked="checked" ' : '' ?>type="radio" name="jform[default_lang_code_ignore]"
                        id="default_lang_code_ignore_yes" value="1" />
                    <label for="default_lang_code_ignore_yes">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_YES'); ?>
                    </label>

                    <input class="form-check-input" <?php echo !$this->item->default_lang_code_ignore ? 'checked="checked" ' : '' ?>type="radio" name="jform[default_lang_code_ignore]"
                        id="default_lang_code_ignore_no" value="0" />
                    <label for="default_lang_code_ignore_no">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_NO'); ?>
                    </label>
                </td>
            </tr>
            <tr>
                <td width="20%" valign="top">
                    <label for="default_publish_up_days"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_PUBLISH_UP_DAYS_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_PUBLISH_UP_DAYS'); ?>
                        </span></label>
                </td>
                <td valign="top">
                    <input class="form-control form-control-sm w-100" type="text" name="jform[default_publish_up_days]"
                        id="default_publish_up_days" value="<?php echo $this->item->default_publish_up_days; ?>" />
                    <br /><br />
                    <label for="article_record_impact_publish"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_ARTICLE_RECORD_PUBLISH_IMPACT_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_ARTICLE_RECORD_PUBLISH_IMPACT'); ?>
                        </span></label>
                    <input class="form-check-input" <?php echo $this->item->article_record_impact_publish ? 'checked="checked" ' : '' ?>type="radio" name="jform[article_record_impact_publish]"
                        id="article_record_impact_publish" value="1" />
                    <label for="article_record_impact_publish_yes">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_YES'); ?>
                    </label>
                    <input class="form-check-input" <?php echo !$this->item->article_record_impact_publish ? 'checked="checked" ' : '' ?>type="radio" name="jform[article_record_impact_publish]"
                        id="article_record_impact_publish_no" value="0" />
                    <label for="article_record_impact_publish_no">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_NO'); ?>
                    </label>

                </td>
                <td width="20%" valign="top">
                    <label for="default_publish_down_days"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_PUBLISH_DOWN_DAYS_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_PUBLISH_DOWN_DAYS'); ?>
                        </span></label>
                </td>
                <td valign="top">
                    <input class="form-control form-control-sm w-100" type="text" name="jform[default_publish_down_days]"
                        id="default_publish_down_days" value="<?php echo $this->item->default_publish_down_days; ?>" />
                </td>

            </tr>
            <tr>
                <td width="20%">
                    <label for="default_access"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_ACCESS_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_ACCESS'); ?>
                        </span></label>
                </td>
                <td>
                    <?php
                    ?>
                    <?php echo HTMLHelper::_('access.level', 'default_access', $this->item->default_access, '', array(), 'default_access'); ?>
                    <?php
                    ?>
                </td>
                <td width="20%">
                    <label for="default_featured"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_FEATURED_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_DEFAULT_FEATURED'); ?>
                        </span></label>
                </td>
                <td>
                    <input class="form-check-input" class="form-check-input" <?php echo $this->item->default_featured ? 'checked="checked" ' : '' ?>type="radio" name="jform[default_featured]" id="default_featured"
                        value="1" />
                    <label for="default_featured">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_YES'); ?>
                    </label>

                    <input class="form-check-input" class="form-check-input" <?php echo !$this->item->default_featured ? 'checked="checked" ' : '' ?>type="radio" name="jform[default_featured]" id="default_featured_no"
                        value="0" />
                    <label for="default_featured_no">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_NO'); ?>
                    </label>

                </td>
            </tr>
            <tr>
                <td width="20%">
                    <label for="auto_publish"><span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_AUTO_PUBLISH_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_AUTO_PUBLISH'); ?>
                        </span></label>
                </td>
                <td>
                    <input type="hidden" name="jform[auto_publish]" value="0" />
                    <?php echo $renderCheckbox('jform[auto_publish]', 'auto_publish', (int) $this->item->auto_publish === 1); ?>
                </td>
                <td width="20%">
                    <?php
                    if ($this->item->edit_by_type && $this->item->type == 'com_breezingforms') {
                    ?>
                        <label for="protect_upload_directory"><span class="editlinktip hasTip"
                                title="<?php echo Text::_('COM_CONTENTBUILDER_NG_UPLOAD_DIRECTORY_TYPE_TIP'); ?>">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PROTECT_UPLOAD_DIRECTORY'); ?>
                            </span></label>
                    <?php
                    }
                    ?>
                </td>
                <td>
                    <?php
                    if ($this->item->edit_by_type && $this->item->type == 'com_breezingforms') {
                    ?>
                        <input type="hidden" name="jform[protect_upload_directory]" value="0" />
                        <?php echo $renderCheckbox('jform[protect_upload_directory]', 'protect_upload_directory', trim((string) $this->item->protect_upload_directory) !== ''); ?>
                    <?php
                    }
                    ?>
                </td>
            </tr>
        </table>

        <?php
        echo $this->form->renderField('details_template');
        //        $editor = Editor::getInstance(Factory::getApplication()->get('editor'));
        //        echo $editor->display('details_template', $this->item->details_template, '100%', '550', '75', '20', true, 'details_template');

        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab4', Text::_('COM_CONTENTBUILDER_NG_DETAILS_PREPARE'));
        if (trim($this->item->details_prepare ?? '') == '') {
            $this->item->details_prepare = '// Here you may alter labels and values for each item before it gets rendered through your details template.' . "\n";
            $this->item->details_prepare .= '// For example:' . "\n";
            $this->item->details_prepare .= '// $items["ITEMNAME"]["value"] = "<b>".$items["ITEMNAME"]["value"]."</b>";' . "\n";
            $this->item->details_prepare .= '// $items["ITEMNAME"]["label"] = "<i>".$items["ITEMNAME"]["label"]."</i>";' . "\n";
        }

        $params = array('syntax' => 'php');
        echo $this->form->renderField('details_prepare', null, $this->item->details_prepare);

        //echo '<textarea name="jform[details_prepare]" style="width:100%;height: 500px;">'.htmlentities($this->item->details_prepare, ENT_QUOTES, 'UTF-8').'</textarea>';
        ?>
        <?php
        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab5', Text::_('COM_CONTENTBUILDER_NG_EDITABLE_TEMPLATE'));

        if ($this->item->edit_by_type && $this->item->type == 'com_breezingforms') {
            echo Text::_('COM_CONTENTBUILDER_NG_EDITABLE_TEMPLATE_PROVIDED_BY_BREEZINGFORMS');
            echo '<input type="hidden" name="jform[editable_template]" value="{BreezingForms: ' . (isset($this->item->type_name) ? $this->item->type_name : '') . '}"/>';
            //echo '<input type="hidden" name="jform[protect_upload_directory]" value="'.(trim($this->item->protect_upload_directory) ? 1 : 0).'"/>'; 
            echo '<input type="hidden" name="jform[upload_directory]" value="' . (trim($this->item->upload_directory) ? trim($this->item->upload_directory) : JPATH_SITE . '/media/contentbuilder_ng/upload') . '"/>';
        } else {
        ?>

            <label for="upload_directory"><span class="editlinktip hasTip"
                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_UPLOAD_DIRECTORY_TIP'); ?>">
                    <?php echo Text::_('COM_CONTENTBUILDER_NG_UPLOAD_DIRECTORY'); ?>
                </span></label>
            <br />
            <input class="form-control form-control-sm" style="width: 50%;" type="text"
                value="<?php echo trim($this->item->upload_directory) ? trim($this->item->upload_directory) : JPATH_SITE . '/media/contentbuilder_ng/upload'; ?>"
                name="jform[upload_directory]" id="upload_directory" />
            <br />
            <br />
            <input type="hidden" name="jform[protect_upload_directory]" value="0" />
            <?php echo $renderCheckbox('jform[protect_upload_directory]', 'protect_upload_directory', trim((string) $this->item->protect_upload_directory) !== ''); ?> <label class="form-check-label" for="protect_upload_directory">
                <?php echo Text::_('COM_CONTENTBUILDER_NG_PROTECT_UPLOAD_DIRECTORY'); ?>
            </label>
            <br />
            <br />
            <input type="hidden" name="jform[create_editable_sample]" value="0" />
            <?php echo $renderCheckbox('jform[create_editable_sample]', 'editable_sample', !empty($this->item->create_editable_sample)); ?>
            <label class="form-check-label" for="editable_sample">
                <?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE_EDITABLE_SAMPLE'); ?>
            </label>
            <br />
            <br />
        <?php
        }

        echo $this->form->renderField('editable_template');
        //      $editor = Editor::getInstance(Factory::getApplication()->get('editor'));
        //      echo $editor->display('editable_template', $this->item->editable_template, '100%', '550', '75', '20', true, 'editable_template');
        ?>
        <?php
        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab6', Text::_('COM_CONTENTBUILDER_NG_EDITABLE_PREPARE'));

        if ($this->item->edit_by_type) {
            echo Text::_('COM_CONTENTBUILDER_NG_EDITABLE_TEMPLATE_PROVIDED_BY_BREEZINGFORMS');
            echo '<input type="hidden" name="jform[editable_prepare]" value="' . htmlentities($this->item->editable_prepare ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
        } else {
            if (trim($this->item->editable_prepare ?? '') == '') {
                $this->item->editable_prepare = '// Here you may alter labels and values for each item before it gets rendered through your editable template.' . "\n";
                $this->item->editable_prepare .= '// For example:' . "\n";
                $this->item->editable_prepare .= '// $items["ITEMNAME"]["value"] = $items["ITEMNAME"]["value"];' . "\n";
                $this->item->editable_prepare .= '// $items["ITEMNAME"]["label"] = "<i>".$items["ITEMNAME"]["label"]."</i>";' . "\n";
            }

            $params = array('syntax' => 'php');
            echo $this->form->renderField('editable_prepare', null, $this->item->editable_prepare);
        }

        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab7', Text::_('COM_CONTENTBUILDER_NG_EMAIL_TEMPLATES'));

        if ($this->item->edit_by_type) {
            echo Text::_('COM_CONTENTBUILDER_NG_EDITABLE_TEMPLATE_PROVIDED_BY_BREEZINGFORMS');
            echo '<input type="hidden" name="jform[email_admin_template]" value="' . htmlentities($this->item->email_admin_template ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_template]" value="' . htmlentities($this->item->email_template ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_admin_subject]" value="' . htmlentities($this->item->email_admin_subject ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_admin_alternative_from]" value="' . htmlentities($this->item->email_admin_alternative_from ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_admin_alternative_fromname]" value="' . htmlentities($this->item->email_admin_alternative_fromname ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_admin_recipients]" value="' . htmlentities($this->item->email_admin_recipients ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_admin_recipients_attach_uploads]" value="' . htmlentities($this->item->email_admin_recipients_attach_uploads ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_admin_html]" value="' . htmlentities($this->item->email_admin_html ?? '', ENT_QUOTES, 'UTF-8') . '"/>';

            echo '<input type="hidden" name="jform[email_subject]" value="' . htmlentities($this->item->email_subject ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_alternative_from]" value="' . htmlentities($this->item->email_alternative_from ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_alternative_fromname]" value="' . htmlentities($this->item->email_alternative_fromname ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_recipients]" value="' . htmlentities($this->item->email_recipients ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_recipients_attach_uploads]" value="' . htmlentities($this->item->email_recipients_attach_uploads ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
            echo '<input type="hidden" name="jform[email_html]" value="' . htmlentities($this->item->email_html ?? '', ENT_QUOTES, 'UTF-8') . '"/>';
        } else {

            $title = Text::_('COM_CONTENTBUILDER_NG_EMAIL_ADMINS');

        ?>
            <div id="email_admins" style="cursor:pointer; width: 100%; background-color: #ffffff;"
                onclick="if(document.adminForm.email_admins.value=='none'){document.adminForm.email_admins.value='';document.getElementById('email_admins_div').style.display='';}else{document.adminForm.email_admins.value='none';document.getElementById('email_admins_div').style.display='none';}">
                <h3>
                    <?php echo $title; ?>
                </h3>
            </div>
            <div id="email_admins_div"
                style="display:<?php echo Factory::getApplication()->getSession()->get('email_admins', '', 'com_contentbuilder_ng'); ?>">
                <table width="100%" class="table table-striped">
                    <tr>
                        <td width="20%">
                            <label for="email_admin_subject"><span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_SUBJECT_TIP'); ?>">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_SUBJECT'); ?>
                                </span></label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_admin_subject" type="text"
                                name="jform[email_admin_subject]"
                                value="<?php echo htmlentities($this->item->email_admin_subject ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                        <td width="20%">
                            <label for="email_admin_alternative_from">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ALTERNATIVE_FROM'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_admin_alternative_from" type="text"
                                name="jform[email_admin_alternative_from]"
                                value="<?php echo htmlentities($this->item->email_admin_alternative_from ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <label for="email_admin_alternative_fromname">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ALTERNATIVE_FROMNAME'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_admin_alternative_fromname"
                                type="text" name="jform[email_admin_alternative_fromname]"
                                value="<?php echo htmlentities($this->item->email_admin_alternative_fromname ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                        <td width="20%">
                            <label for="email_admin_recipients"><span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_RECIPIENTS_TIP'); ?>">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_RECIPIENTS'); ?>
                                </span></label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_admin_recipients" type="text"
                                name="jform[email_admin_recipients]"
                                value="<?php echo htmlentities($this->item->email_admin_recipients ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <label for="email_admin_recipients_attach_uploads"><span class="editlinktip hasTip"
                                    title="<?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ATTACH_UPLOADS_TIP'); ?>">
                                    <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ATTACH_UPLOADS'); ?>
                                </span></label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_admin_recipients_attach_uploads"
                                type="text" name="jform[email_admin_recipients_attach_uploads]"
                                value="<?php echo htmlentities($this->item->email_admin_recipients_attach_uploads ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                        <td width="20%">
                            <label for="email_admin_html">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_HTML'); ?>
                            </label>
                        </td>
                        <td>
                            <input type="hidden" name="jform[email_admin_html]" value="0" />
                            <?php echo $renderCheckbox('jform[email_admin_html]', 'email_admin_html', (bool) $this->item->email_admin_html); ?>
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <label for="email_admin_create_sample">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE_EDITABLE_SAMPLE'); ?>
                            </label>
                        </td>
                        <td>
                            <input type="hidden" name="jform[email_admin_create_sample]" value="0" />
                            <?php echo $renderCheckbox('jform[email_admin_create_sample]', 'email_admin_create_sample', !empty($this->item->email_admin_create_sample)); ?>
                        </td>
                        <td width="20%">
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>

                <?php
                $params = array('syntax' => 'html');
                echo $this->form->renderField('email_admin_template');
                ?>
            </div>
            <?php

            $title = Text::_('COM_CONTENTBUILDER_NG_EMAIL_USERS');

            ?>
            <div id="email_users" style="cursor:pointer; width: 100%; background-color: #ffffff;">
                <h3>
                    <?php echo $title; ?>
                </h3>
            </div>
            <div id="email_users_div">
                <table width="100%" class="table table-striped">
                    <tr>
                        <td width="20%">
                            <label for="email_subject">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_SUBJECT'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_subject" type="text"
                                name="jform[email_subject]"
                                value="<?php echo htmlentities($this->item->email_subject ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                        <td width="20%">
                            <label for="email_alternative_from">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ALTERNATIVE_FROM'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_alternative_from" type="text"
                                name="jform[email_alternative_from]"
                                value="<?php echo htmlentities($this->item->email_alternative_from ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <label for="email_alternative_fromname">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ALTERNATIVE_FROMNAME'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_alternative_fromname" type="text"
                                name="jform[email_alternative_fromname]"
                                value="<?php echo htmlentities($this->item->email_alternative_fromname ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                        <td width="20%">
                            <label for="email_recipients">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_RECIPIENTS'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_recipients" type="text"
                                name="jform[email_recipients]"
                                value="<?php echo htmlentities($this->item->email_recipients ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <label for="email_recipients_attach_uploads">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_ATTACH_UPLOADS'); ?>
                            </label>
                        </td>
                        <td>
                            <input class="form-control form-control-sm w-100" id="email_recipients_attach_uploads"
                                type="text" name="jform[email_recipients_attach_uploads]"
                                value="<?php echo htmlentities($this->item->email_recipients_attach_uploads ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        </td>
                        <td width="20%">
                            <label for="email_html">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_EMAIL_HTML'); ?>
                            </label>
                        </td>
                        <td>
                            <input type="hidden" name="jform[email_html]" value="0" />
                            <?php echo $renderCheckbox('jform[email_html]', 'email_html', (bool) $this->item->email_html); ?>
                        </td>
                    </tr>
                    <tr>
                        <td width="20%">
                            <label for="email_create_sample">
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_CREATE_EDITABLE_SAMPLE'); ?>
                            </label>
                        </td>
                        <td>
                            <input type="hidden" name="jform[email_create_sample]" value="0" />
                            <?php echo $renderCheckbox('jform[email_create_sample]', 'email_create_sample', !empty($this->item->email_create_sample)); ?>
                        </td>
                        <td width="20%">
                        </td>
                        <td>
                        </td>
                    </tr>
                </table>

                <?php
                $params = array('syntax' => 'html');
                echo $this->form->renderField('email_template');
                ?>
            </div>
        <?php
        }

        echo HTMLHelper::_('uitab.endTab');
        echo HTMLHelper::_('uitab.addTab', 'view-pane', 'tab8', Text::_('COM_CONTENTBUILDER_NG_PERMISSIONS'));

        // DÃ©marrer les onglets
        $activePermTab = Factory::getApplication()->getSession()->get('slideStartOffset', 'permtab1', 'com_contentbuilder_ng');
        echo HTMLHelper::_('uitab.startTabSet', 'perm-pane', ['active' => $activePermTab]);


        // Premier onglet
        echo HTMLHelper::_('uitab.addTab', 'perm-pane', 'permtab1', Text::_('COM_CONTENTBUILDER_NG_PERMISSIONS_FRONTEND'));
        ?>
        <table class="table table-striped">
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="own_only_fe">
                        <span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_OWN_OWNLY_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_OWN_OWNLY'); ?>
                        </span>:
                    </label>
                </td>
                <td>
                    <input type="hidden" name="jform[own_only_fe]" value="0" />
                    <?php echo $renderCheckbox('jform[own_only_fe]', 'own_only_fe', (bool) $this->item->own_only_fe); ?>
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="limited_article_options_fe">
                        <span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_LIMITED_ARTICLE_OPTIONS_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_LIMITED_ARTICLE_OPTIONS'); ?>
                        </span>:
                    </label>
                </td>
                <td>
                    <input type="hidden" name="jform[limited_article_options_fe]" value="0" />
                    <?php echo $renderCheckbox('jform[limited_article_options_fe]', 'limited_article_options_fe', (bool) $this->item->limited_article_options_fe); ?>
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="own_fe_view">
                        <span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_OWN_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_OWN'); ?>
                        </span>:
                    </label>
                </td>
                <td>
                    <?php foreach ($permissionColumns as $permissionColumn) : ?>
                        <?php
                        $permKey = $permissionColumn['key'];
                        $permId = 'own_fe_' . $permKey;
                        $permName = 'jform[own_fe][' . $permKey . ']';
                        $isChecked = !empty($this->item->config['own_fe'][$permKey]);
                        ?>
                        <?php echo $renderCheckbox($permName, $permId, $isChecked); ?>
                        <label class="form-check-label me-2" for="<?php echo $permId; ?>">
                            <?php echo Text::_($permissionColumn['label']); ?>
                        </label>
                    <?php endforeach; ?>
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="show_all_languages_fe">
                        <span class="editlinktip hasTip"
                            title="<?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_SHOW_ALL_LANGUAGES_TIP'); ?>">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_SHOW_ALL_LANGUAGES'); ?>
                        </span>:
                    </label>
                </td>
                <td>
                    <input type="hidden" name="jform[show_all_languages_fe]" value="0" />
                    <?php echo $renderCheckbox('jform[show_all_languages_fe]', 'show_all_languages_fe', (bool) $this->item->show_all_languages_fe); ?>
                </td>
            </tr>
            <?php
            if ($this->item->edit_by_type) {
            ?>
                <tr class="row0">
                    <td width="20%" align="right" class="key">
                        <label for="force_login">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_FORCE_LOGIN'); ?>
                        </label>
                    </td>
                    <td>
                        <input type="hidden" name="jform[force_login]" value="0" />
                        <?php echo $renderCheckbox('jform[force_login]', 'force_login', (bool) $this->item->force_login); ?>
                    </td>
                </tr>
                <tr class="row0">
                    <td width="20%" align="right" class="key">
                        <label for="force_url">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_FORCE_URL'); ?>
                        </label>
                    </td>
                    <td>
                        <input style="width: 100%;" id="force_url" name="jform[force_url]" type="text"
                            value="<?php echo htmlentities($this->item->force_url ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                    </td>
                </tr>
            <?php
            }
            ?>
        </table>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <?php echo $permHeaderLabel('COM_CONTENTBUILDER_NG_PERM_GROUP', 'COM_CONTENTBUILDER_NG_PERM_GROUP_TIP'); ?>
                    </th>
                    <?php foreach ($permissionColumns as $permissionColumn) : ?>
                        <th>
                            <?php echo $permHeaderLabel($permissionColumn['label'], $permissionColumn['tip']); ?>
                        </th>
                    <?php endforeach; ?>
                </tr>
            </thead>
            <tr>
                <td class="bg-light"></td>
                <?php foreach ($permissionColumns as $permissionColumn) : ?>
                    <?php
                    $permKey = $permissionColumn['key'];
                    $permId = 'perms_fe_select_' . $permKey;
                    ?>
                    <td class="bg-light">
                        <?php echo $renderCheckbox('', $permId, false, $permKey, ['onclick' => "contentbuilder_ng_selectAll(this,'fe')"]); ?>
                    </td>
                <?php endforeach; ?>
            </tr>

            <?php
            foreach ($this->gmap as $entry) {
                $k = 0;
            ?>
                <tr class="<?php echo "row$k"; ?>">
                    <td>
                        <?php echo $entry->text; ?>
                    </td>
                    <?php
                    $groupPermissions = $this->item->config['permissions_fe'][$entry->value] ?? [];
                    foreach ($permissionColumns as $permissionColumn) {
                        $permKey = $permissionColumn['key'];
                        $permName = 'jform[perms_fe][' . $entry->value . '][' . $permKey . ']';
                        $permId = 'perms_fe_' . $entry->value . '_' . $permKey;
                        $isChecked = !$this->item->id && !empty($defaultCheckedForNewPermissions[$permKey]);

                        if (!$isChecked) {
                            $isChecked = !empty($groupPermissions[$permKey]);
                        }

                        echo '<td>' . $renderCheckbox($permName, $permId, $isChecked) . '</td>';
                    }
                    ?>
                </tr>
            <?php
                $k = 1 - $k;
            }
            ?>
        </table>
        <?php
        echo HTMLHelper::_('uitab.endTab');
        // Legacy backend permissions block removed in favor of Joomla 6 frontend permissions UI.


        echo HTMLHelper::_('uitab.addTab', 'perm-pane', 'permtab2', Text::_('COM_CONTENTBUILDER_NG_PERMISSIONS_USERS'));
        ?>

        <table class="table table-striped">
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="limit_add">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_LIMIT_ADD'); ?>:
                    </label>
                </td>
                <td>
                    <input class="form-control form-control-sm w-100" id="limit_add" name="jform[limit_add]" type="text"
                        value="<?php echo $this->item->limit_add; ?>" />
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="limit_edit">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_LIMIT_EDIT'); ?>:
                    </label>
                </td>
                <td>
                    <input class="form-control form-control-sm w-100" id="limit_edit" name="jform[limit_edit]" type="text"
                        value="<?php echo $this->item->limit_edit; ?>" />
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="verification_required_view">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VIEW'); ?>:
                    </label>
                </td>
                <td>
                    <input type="hidden" name="jform[verification_required_view]" value="0" />
                    <?php echo $renderCheckbox('jform[verification_required_view]', 'verification_required_view', (bool) $this->item->verification_required_view); ?><label class="form-check-label" for="verification_required_view">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_REQUIRED'); ?>
                    </label>
                    <input class="form-control form-control-sm" style="width: 50px;" id="verification_days_view"
                        name="jform[verification_days_view]" type="text"
                        value="<?php echo $this->item->verification_days_view; ?>" /> <label
                        for="verification_days_view">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_DAYS'); ?>
                    </label>
                    <input class="form-control form-control-sm" style="width: 300px;" id="verification_url_view"
                        name="jform[verification_url_view]" type="text"
                        value="<?php echo htmlentities($this->item->verification_url_view ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                    <label for="verification_url_view">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_URL'); ?>
                    </label>
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="verification_required_new">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_NEW'); ?>:
                    </label>
                </td>
                <td>
                    <input type="hidden" name="jform[verification_required_new]" value="0" />
                    <?php echo $renderCheckbox('jform[verification_required_new]', 'verification_required_new', (bool) $this->item->verification_required_new); ?><label class="form-check-label" for="verification_required_new">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_REQUIRED'); ?>
                    </label>
                    <input class="form-control form-control-sm" style="width: 50px;" id="verification_days_new"
                        name="jform[verification_days_new]" type="text"
                        value="<?php echo $this->item->verification_days_new; ?>" /> <label for="verification_days_new">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_DAYS'); ?>
                    </label>
                    <input class="form-control form-control-sm" style="width: 300px;" id="verification_url_new"
                        name="jform[verification_url_new]" type="text"
                        value="<?php echo htmlentities($this->item->verification_url_new ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                    <label for="verification_url_new">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_URL'); ?>
                    </label>
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label for="verification_required_edit">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_EDIT'); ?>:
                    </label>
                </td>
                <td>
                    <input type="hidden" name="jform[verification_required_edit]" value="0" />
                    <?php echo $renderCheckbox('jform[verification_required_edit]', 'verification_required_edit', (bool) $this->item->verification_required_edit); ?><label class="form-check-label" for="verification_required_edit">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_REQUIRED'); ?>
                    </label>
                    <input class="form-control form-control-sm" style="width: 50px;" id="verification_days_edit"
                        name="jform[verification_days_edit]" type="text"
                        value="<?php echo $this->item->verification_days_edit; ?>" /> <label
                        for="verification_days_edit">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_DAYS'); ?>
                    </label>
                    <input class="form-control form-control-sm" style="width: 300px;" id="verification_url_new"
                        name="jform[verification_url_edit]" type="text"
                        value="<?php echo htmlentities($this->item->verification_url_edit ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                    <label for="verification_url_edit">
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_VERIFICATION_URL'); ?>
                    </label>
                </td>
            </tr>
            <tr class="row0">
                <td width="20%" align="right" class="key">
                    <label>
                        <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_USERS'); ?>:
                    </label>
                </td>
                <td>
                    <?php echo '[<a href="index.php?option=com_contentbuilder_ng&amp;view=users&amp;tmpl=component&amp;form_id=' . $this->item->id . '" title="" data-bs-toggle="modal" data-bs-target="#edit-modal">' . Text::_('COM_CONTENTBUILDER_NG_EDIT') . '</a>]'; ?>

                </td>
            </tr>
            <?php
            if (!$this->item->edit_by_type) {
            ?>
                <tr class="row0">
                    <td width="20%" align="right" class="key" valign="top">
                        <label for="act_as_registration">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION'); ?>:
                        </label>
                    </td>
                    <td>
                        <input type="hidden" name="jform[act_as_registration]" value="0" />
                        <?php echo $renderCheckbox('jform[act_as_registration]', 'act_as_registration', (bool) $this->item->act_as_registration); ?>
                        <br />
                        <br />
                        <select class="form-select-sm" name="jform[registration_name_field]" id="registration_name_field"
                            style="max-width: 200px;">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION_NAME_FIELD'); ?> -
                            </option>
                            <?php
                            foreach ($this->elements as $the_element) {
                            ?>
                                <option value="<?php echo $the_element->reference_id; ?>" <?php echo $this->item->registration_name_field == $the_element->reference_id ? ' selected="selected"' : ''; ?>>
                                    <?php echo htmlentities($the_element->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    </value>
                                <?php
                            }
                                ?>
                        </select>
                        <br />
                        <br />
                        <select class="form-select-sm" name="jform[registration_username_field]" id="registration_username_field"
                            style="max-width: 200px;">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION_USERNAME_FIELD'); ?> -
                            </option>
                            <?php
                            foreach ($this->elements as $the_element) {
                            ?>
                                <option value="<?php echo $the_element->reference_id; ?>" <?php echo $this->item->registration_username_field == $the_element->reference_id ? ' selected="selected"' : ''; ?>>
                                    <?php echo htmlentities($the_element->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    </value>
                                <?php
                            }
                                ?>
                        </select>
                        <br />
                        <br />
                        <select class="form-select-sm" name="jform[registration_email_field]" id="registration_email_field"
                            style="max-width: 200px;">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION_EMAIL_FIELD'); ?> -
                            </option>
                            <?php
                            foreach ($this->elements as $the_element) {
                            ?>
                                <option value="<?php echo $the_element->reference_id; ?>" <?php echo $this->item->registration_email_field == $the_element->reference_id ? ' selected="selected"' : ''; ?>>
                                    <?php echo htmlentities($the_element->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    </value>
                                <?php
                            }
                                ?>
                        </select>
                        <br />
                        <br />
                        <select class="form-select-sm" name="jform[registration_email_repeat_field]"
                            id="registration_email_repeat_field" style="max-width: 200px;">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION_EMAIL_REPEAT_FIELD'); ?> -
                            </option>
                            <?php
                            foreach ($this->elements as $the_element) {
                            ?>
                                <option value="<?php echo $the_element->reference_id; ?>" <?php echo $this->item->registration_email_repeat_field == $the_element->reference_id ? ' selected="selected"' : ''; ?>>
                                    <?php echo htmlentities($the_element->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    </value>
                                <?php
                            }
                                ?>
                        </select>
                        <br />
                        <br />
                        <select class="form-select-sm" name="jform[registration_password_field]" id="registration_password_field"
                            style="max-width: 200px;">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION_PASSWORD_FIELD'); ?> -
                            </option>
                            <?php
                            foreach ($this->elements as $the_element) {
                            ?>
                                <option value="<?php echo $the_element->reference_id; ?>" <?php echo $this->item->registration_password_field == $the_element->reference_id ? ' selected="selected"' : ''; ?>>
                                    <?php echo htmlentities($the_element->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    </value>
                                <?php
                            }
                                ?>
                        </select>
                        <br />
                        <br />
                        <select class="form-select-sm" name="jform[registration_password_repeat_field]"
                            id="registration_password_repeat_field" style="max-width: 200px;">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_ACT_AS_REGISTRATION_PASSWORD_REPEAT_FIELD'); ?>
                                -
                            </option>
                            <?php
                            foreach ($this->elements as $the_element) {
                            ?>
                                <option value="<?php echo $the_element->reference_id; ?>" <?php echo $this->item->registration_password_repeat_field == $the_element->reference_id ? ' selected="selected"' : ''; ?>>
                                    <?php echo htmlentities($the_element->label ?? '', ENT_QUOTES, 'UTF-8'); ?>
                                    </value>
                                <?php
                            }
                                ?>
                        </select>
                        <br />
                        <br />
                        <label for="force_login">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_FORCE_LOGIN'); ?>
                        </label>
                        <br />
                        <input type="hidden" name="jform[force_login]" value="0" />
                        <?php echo $renderCheckbox('jform[force_login]', 'force_login', (bool) $this->item->force_login); ?>
                        <br />
                        <br />
                        <label for="force_url">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_FORCE_URL'); ?>
                        </label>
                        <br />
                        <input class="form-control form-control-sm" id="force_url" name="jform[force_url]" type="text"
                            value="<?php echo htmlentities($this->item->force_url ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        <br />
                        <br />
                        <label for="registration_bypass_plugin">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_REGISTRATION_BYPASS_PLUGIN'); ?>
                        </label>
                        <br />
                        <select class="form-select-sm" name="jform[registration_bypass_plugin]" id="registration_bypass_plugin">
                            <option value=""> -
                                <?php echo Text::_('COM_CONTENTBUILDER_NG_NONE'); ?> -
                            </option>
                            <?php
                            foreach ($this->verification_plugins as $registration_bypass_plugin) {
                            ?>
                                <option value="<?php echo $registration_bypass_plugin; ?>" <?php echo $registration_bypass_plugin == $this->item->registration_bypass_plugin ? ' selected="selected"' : ''; ?>>
                                    <?php echo $registration_bypass_plugin; ?>
                                </option>
                            <?php
                            }
                            ?>
                        </select>
                        <br />
                        <br />
                        <label for="registration_bypass_verification_name">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_REGISTRATION_BYPASS_VERIFICATION_NAME'); ?>
                        </label>
                        <br />
                        <input class="form-control form-control-sm" type="text" name="jform[registration_bypass_verification_name]"
                            id="registration_bypass_verification_name"
                            value="<?php echo htmlentities($this->item->registration_bypass_verification_name ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                        <br />
                        <br />
                        <label for="registration_bypass_verify_view">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_REGISTRATION_BYPASS_VERIFICATION_VIEW'); ?>
                        </label>
                        <br />
                        <input class="form-control form-control-sm" type="text" name="jform[registration_bypass_verify_view]"
                            id="registration_bypass_verify_view"
                            value="<?php echo htmlentities($this->item->registration_bypass_verify_view ?? '', ENT_QUOTES, 'UTF-8'); ?>" />

                        <br />
                        <br />
                        <label for="registration_bypass_plugin_params">
                            <?php echo Text::_('COM_CONTENTBUILDER_NG_PERM_REGISTRATION_BYPASS_PLUGIN_PARAMS'); ?>
                        </label>
                        <br />
                        <textarea class="form-control form-control-sm" style="width: 100%;height: 80px;"
                            name="jform[registration_bypass_plugin_params]"
                            id="registration_bypass_plugin_params"><?php echo htmlentities($this->item->registration_bypass_plugin_params ?? '', ENT_QUOTES, 'UTF-8'); ?></textarea>
                    </td>
                </tr>
            <?php
            } else {
            ?>
                <input type="hidden" name="jform[act_as_registration]"
                    value="<?php echo htmlentities($this->item->act_as_registration ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_name_field]"
                    value="<?php echo htmlentities($this->item->registration_name_field ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_username_field]"
                    value="<?php echo htmlentities($this->item->registration_username_field ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_email_field]"
                    value="<?php echo htmlentities($this->item->registration_email_field ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_email_repeat_field]"
                    value="<?php echo htmlentities($this->item->registration_email_repeat_field ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_password_field]"
                    value="<?php echo htmlentities($this->item->registration_password_field ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_password_repeat_field]"
                    value="<?php echo htmlentities($this->item->registration_password_repeat_field ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_bypass_plugin]"
                    value="<?php echo htmlentities($this->item->registration_bypass_plugin ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_bypass_verification_name]"
                    value="<?php echo htmlentities($this->item->registration_bypass_verification_name ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_bypass_verify_view]"
                    value="<?php echo htmlentities($this->item->registration_bypass_verify_view ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
                <input type="hidden" name="jform[registration_bypass_plugin_params]"
                    value="<?php echo htmlentities($this->item->registration_bypass_plugin_params ?? '', ENT_QUOTES, 'UTF-8'); ?>" />
            <?php
            }
            ?>
        </table>

        <?php
        echo HTMLHelper::_('uitab.endTab'); // â ferme permtab2
        echo HTMLHelper::_('uitab.endTabSet'); // â ferme perm-pane

        echo HTMLHelper::_('uitab.endTab');     // ferme tab8 (Permissions)
        echo HTMLHelper::_('uitab.endTabSet');  // ferme view-pane
        ?>

    </div>

    <div class="clr"></div>

    <input type="hidden" name="option" value="com_contentbuilder_ng" />
    <input type="hidden" name="id" value="<?php echo (int) $this->item->id; ?>" />
    <input type="hidden" name="jform[id]" value="<?php echo (int) $this->item->id; ?>" />
    <input type="hidden" name="task" value="" />
    <input type="hidden" name="limitstart" value="" />
    <input type="hidden" name="jform[ordering]" value="<?php echo $this->item->ordering; ?>" />
    <input type="hidden" name="jform[published]" value="<?php echo $this->item->published; ?>" />
    <input type="hidden" name="list[ordering]" value="<?php echo htmlspecialchars($listOrder, ENT_QUOTES, 'UTF-8'); ?>" />
    <input type="hidden" name="list[direction]" value="<?php echo htmlspecialchars($listDirn, ENT_QUOTES, 'UTF-8'); ?>" />
    <input type="hidden" name="boxchecked" value="0" />
    <input type="hidden" name="hidemainmenu" value="0" />
    <input type="hidden" name="tabStartOffset" value="<?php echo Factory::getApplication()->getSession()->get('tabStartOffset', 0); ?>" />
    <input type="hidden" name="slideStartOffset"
        value="<?php echo Factory::getApplication()->getSession()->get('slideStartOffset', 1); ?>" />
    <input type="hidden" name="jform[email_users]"
        value="<?php echo Factory::getApplication()->getSession()->get('email_users', 'none', 'com_contentbuilder_ng'); ?>" />
    <input type="hidden" name="jform[email_admins]"
        value="<?php echo Factory::getApplication()->getSession()->get('email_admins', '', 'com_contentbuilder_ng'); ?>" />

    <?php echo HTMLHelper::_('form.token'); ?>

</form>
<?php
$textTypeModalParams = [
    'title' => Text::_('COM_CONTENTBUILDER_NG_EDIT'),
    'url' => '#',
    'height' => '100%',
    'width' => '100%',
    'bodyHeight' => 80,
    'modalWidth' => 90,
];
echo HTMLHelper::_('bootstrap.renderModal', 'text-type-modal', $textTypeModalParams);

$editModalParams = [
    'title' => Text::_('COM_CONTENTBUILDER_NG_EDIT'),
    'url' => '#',
    'height' => '400',
    'width' => '800',
    'bodyHeight' => 60,
    'modalWidth' => 80,
];
echo HTMLHelper::_('bootstrap.renderModal', 'edit-modal', $editModalParams);

$wa = Factory::getApplication()->getDocument()->getWebAssetManager();
$wa->useScript('jquery');
//$wa->useScript('bootstrap.tab');
?>

<script>
    let textTypeModal = document.getElementById('text-type-modal');
    textTypeModal.addEventListener('shown.bs.modal', function(event) {
        const modal = jQuery('#text-type-modal');
        const body = modal.find('.modal-body');
        body.css('display', 'none');
        modal.find('iframe').attr('src', event.relatedTarget.href);
        body.css('display', '');
    });

    let editModal = document.getElementById('edit-modal');
    editModal.addEventListener('shown.bs.modal', function(event) {
        const modal = jQuery('#edit-modal');
        const body = modal.find('.modal-body');
        body.css('display', 'none');
        modal.find('iframe').attr('src', event.relatedTarget.href);
        body.css('display', '');
    });

    (() => {
        // ClÃ©s de stockage
        const KEY_VIEW = 'cb_active_view_tab';
        const KEY_PERM = 'cb_active_perm_tab';
        const tooltipSelector = '[data-bs-toggle="tooltip"]';

        // Helpers
        const $ = (sel, root = document) => root.querySelector(sel);

        function initBootstrapTooltips(root = document) {
            if (!window.bootstrap || typeof window.bootstrap.Tooltip !== 'function') {
                return;
            }

            root.querySelectorAll(tooltipSelector).forEach((el) => {
                if (!window.bootstrap.Tooltip.getInstance(el)) {
                    new window.bootstrap.Tooltip(el);
                }
            });
        }

        function setHidden(name, value) {
            const el = document.querySelector(`input[name="jform[${name}]"]`);
            if (el) el.value = value;
        }

        /**
         * Persistance d'un joomla-tab (uitab)
         * @param {string} tabsetId  ex: 'view-pane' ou 'perm-pane'
         * @param {string} storageKey
         * @param {(value:string)=>void} onSave  callback optionnel (ex: hidden input)
         */
        function persistJoomlaTabset(tabsetId, storageKey, onSave) {
            const tabset = document.getElementById(tabsetId);
            if (!tabset) return;

            // Joomla gÃ©nÃ¨re souvent un <joomla-tab> avec des <button> ou des liens internes.
            const jTab = tabset.matches('joomla-tab') ? tabset : tabset.querySelector('joomla-tab');
            if (!jTab) return;

            // Restauration : si on a une valeur stockÃ©e, on tente d'activer cet onglet
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                // 1) tente via API si dispo
                if (typeof jTab.show === 'function') {
                    try {
                        jTab.show(saved);
                    } catch (e) {}
                }

                // 2) fallback : cliquer un bouton correspondant
                // Les boutons ont souvent aria-controls ou data-tab / data-target
                const btn =
                    jTab.querySelector(`button[aria-controls="${saved}"]`) ||
                    jTab.querySelector(`button[data-tab="${saved}"]`) ||
                    jTab.querySelector(`button[data-target="#${saved}"]`) ||
                    jTab.querySelector(`a[aria-controls="${saved}"]`) ||
                    jTab.querySelector(`a[href="#${saved}"]`);

                if (btn) {
                    btn.click();
                    btn.blur?.();
                }
            }

            // Sauvegarde : Ã©couter les clics sur onglets
            jTab.addEventListener('click', (ev) => {
                const t = ev.target;

                // Cherche un identifiant d'onglet stable
                const id =
                    t?.getAttribute?.('aria-controls') ||
                    t?.getAttribute?.('data-tab') ||
                    (t?.getAttribute?.('href')?.startsWith('#') ? t.getAttribute('href').slice(1) : null) ||
                    (t?.getAttribute?.('data-target')?.startsWith('#') ? t.getAttribute('data-target').slice(1) : null);

                if (!id) return;

                localStorage.setItem(storageKey, id);
                if (typeof onSave === 'function') onSave(id);
            }, {
                passive: true
            });
        }

        // 1) onglets principaux view-pane (tab0, tab1, tab2â¦)
        persistJoomlaTabset('view-pane', KEY_VIEW, (id) => {
            // Optionnel : si tu veux continuer avec tabStartOffset
            // Ici je stocke l'id, si tu veux l'index, dis-moi et je te donne la variante.
            setHidden('tabStartOffset', id);
        });

        // 2) onglets internes permissions perm-pane (permtab1, permtab2â¦)
        persistJoomlaTabset('perm-pane', KEY_PERM, (id) => {
            setHidden('slideStartOffset', id);
        });

        initBootstrapTooltips();

    })();
</script>
